"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function makeDistortionCurve(amount){for(var x,k="number"==typeof amount?amount:50,curve=new Float32Array(44100),deg=Math.PI/180,i=0;i<44100;++i)x=2*i/44100-1,curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x));return curve}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function randomItem(array){return array[Math.floor(Math.random()*array.length)]}var AudioContext=window.AudioContext||window.webkitAudioContext,audioCtx=new AudioContext,GamePiece=function GamePiece(grid){var _this=this;_classCallCheck(this,GamePiece),this.grid=grid,this.on=!0,this.x=grid.randomSpot().x,this.y=grid.randomSpot().y,this.width=10,this.height=10,this.color="#ffffff",this.originalColor="#ffffff",this.shape="circle",this.direction=0,this.speed=4,this.volume=.01,this.gainNode=audioCtx.createGain(),this.gainNode.gain.value=this.volume,this.oscillator=audioCtx.createOscillator(),this.oscillator.start(0),this.oscillator.frequency.value=this.y,this.oscillator.connect(this.gainNode),this.gainNode.connect(audioCtx.destination),this.pulse=function(){_this.gainNode.gain.value=0==_this.gainNode.gain.value?_this.volume:0,_this.color="#9064C3"==_this.color?_this.originalColor:"#9064C3"},this.invertDirection=function(){switch(_this.direction){case 0:_this.direction=180;break;case 90:_this.direction=270;break;case 180:_this.direction=0;break;case 270:_this.direction=90}},this.forward=function(){switch(_this.direction){case 0:_this.y=_this.y+_this.speed;break;case 90:_this.x=_this.x+_this.speed;break;case 180:_this.y=_this.y-_this.speed;break;case 270:_this.x=_this.x-_this.speed}_this.checkWall(grid),_this.oscillator.frequency.value=_this.y},this.checkWall=function(canvas){_this.x+_this.width>canvas.ctx.canvas.width?_this.x=0:_this.x<0?_this.x=canvas.ctx.canvas.width-_this.width:_this.y+_this.height>canvas.ctx.canvas.height?_this.y=0:_this.y<0&&(_this.y=canvas.ctx.canvas.height-_this.height)},this.changeShape=function(shape){_this.shape=shape,_this.oscillator.type=shape},this.hasCollided=function(piece){if(piece.on){var r1Top=_this.y,r1Right=_this.x+_this.width,r1Bottom=_this.y+_this.height,r1Left=_this.x,r2Top=piece.y,r2Right=piece.x+piece.width,r2Bottom=piece.y+piece.height;return!(piece.x>r1Right||r2Right<r1Left||r2Top>r1Bottom||r2Bottom<r1Top)}return!1},this.collide=function(piece){(_this.collisionIndex*_this.speed>piece.collisionIndex*piece.speed?_this:piece).collision()},this.collision=function(piece){piece.on=!1},this.drawMe=function(){switch(_this.shape){case"sine":grid.ctx.beginPath(),grid.ctx.arc(_this.x+_this.width/2,_this.y+_this.height/2,_this.width/2,0,2*Math.PI,!1),grid.ctx.fillStyle=_this.color,grid.ctx.fill(),grid.ctx.lineWidth=1,grid.ctx.strokeStyle=_this.color,grid.ctx.stroke();break;case"square":grid.ctx.fillStyle=_this.color,grid.ctx.fillRect(_this.x,_this.y,_this.width,_this.height);break;case"triangle":grid.ctx.fillStyle=_this.color,grid.ctx.beginPath(),grid.ctx.moveTo(_this.x+_this.width/2,_this.y),grid.ctx.lineTo(_this.x+_this.width,_this.y+_this.height),grid.ctx.lineTo(_this.x,_this.y+_this.height),grid.ctx.fill();break;case"sawtooth":grid.ctx.fillStyle=_this.color,grid.ctx.beginPath(),grid.ctx.moveTo(_this.x,_this.y),grid.ctx.lineTo(_this.x+_this.width/2,_this.y+_this.height),grid.ctx.lineTo(_this.x+_this.width/2,_this.y),grid.ctx.lineTo(_this.x,_this.y),grid.ctx.lineTo(_this.x+_this.width/2,_this.y),grid.ctx.lineTo(_this.x+_this.width,_this.y+_this.height),grid.ctx.lineTo(_this.x+_this.width,_this.y),grid.ctx.lineTo(_this.x,_this.y),grid.ctx.fill()}},this.clearMe=function(grid){grid.ctx.clearRect(_this.x-1,_this.y-1,_this.width+2,_this.height+2)},this.control=function(){window.onkeydown=function(e){switch(e.keyCode){case 37:_this.direction=270;break;case 38:_this.direction=180;break;case 39:_this.direction=90;break;case 40:_this.direction=0}},window.ontouchstart=function(e){var startTouchX=e.touches[0].clientX,startTouchY=e.touches[0].clientY;window.ontouchmove=function(f){var moveTouchX=f.touches[0].clientX,moveTouchY=f.touches[0].clientY,xDelta=Math.abs(startTouchX-moveTouchX),yDelta=Math.abs(startTouchY-moveTouchY);_this.direction=xDelta>yDelta?moveTouchX>startTouchX?90:270:moveTouchY>startTouchY?0:180,f.preventDefault()}},document.addEventListener("gesturestart",function(e){return e.preventDefault()})}},Sawtooth=function(_GamePiece){function Sawtooth(grid){_classCallCheck(this,Sawtooth);var _this=_possibleConstructorReturn(this,(Sawtooth.__proto__||Object.getPrototypeOf(Sawtooth)).call(this,grid));return _this.color="#6C64B9",_this.originalColor="#6C64B9",_this.speed=2,_this.harmful=!0,_this.shape="sawtooth",_this.forward=function(){switch(_this.direction){case 0:_this.y=_this.y+_this.speed;break;case 90:_this.x=_this.x+_this.speed;break;case 180:_this.y=_this.y-_this.speed;break;case 270:_this.x=_this.x-_this.speed}_this.checkWall(grid),_this.oscillator.frequency.value=_this.x/2},_this}return _inherits(Sawtooth,GamePiece),Sawtooth}(),Sine=function(_GamePiece){function Sine(grid){_classCallCheck(this,Sine);var _this=_possibleConstructorReturn(this,(Sine.__proto__||Object.getPrototypeOf(Sine)).call(this,grid));return _this.speed=2,_this.gainNode.gain.value=.025,_this.shape="sine",_this.color="white",_this.originalColor="white",_this}return _inherits(Sine,GamePiece),Sine}(),SpeedReset=function(_GamePiece){function SpeedReset(grid){_classCallCheck(this,SpeedReset);var _this=_possibleConstructorReturn(this,(SpeedReset.__proto__||Object.getPrototypeOf(SpeedReset)).call(this,grid));return _this.speed=8,_this.gainNode.gain.value=.045,_this.shape="triangle",_this.color="#F012BE",_this.originalColor="#F012BE",_this.speedReset=!0,_this.speed=8,_this.width=20,_this.height=20,_this}return _inherits(SpeedReset,GamePiece),SpeedReset}(),Square=function(_GamePiece){function Square(grid){_classCallCheck(this,Square);var _this=_possibleConstructorReturn(this,(Square.__proto__||Object.getPrototypeOf(Square)).call(this,grid));return _this.color="#00ff00",_this.originalColor="#00ff00",_this.speed=8,_this.shape="square",_this.oscillator.type="square",_this}return _inherits(Square,GamePiece),Square}(),Triangle=function(_GamePiece){function Triangle(grid){_classCallCheck(this,Triangle);var _this=_possibleConstructorReturn(this,(Triangle.__proto__||Object.getPrototypeOf(Triangle)).call(this,grid));return _this.color="#ff2222",_this.originalColor="#ff2222",_this.shape="triangle",_this.sizer="down",_this}return _inherits(Triangle,GamePiece),Triangle}(),Grid=function Grid(canvasElement){var _this=this;_classCallCheck(this,Grid),this.ctx=canvasElement.getContext("2d"),this.ctx.canvas.width=window.innerWidth,this.ctx.canvas.height=window.innerHeight,this.centreSpot=function(){return{x:_this.ctx.canvas.width/2,y:_this.ctx.canvas.height/2}},this.randomSpot=function(){return{x:Math.floor(Math.random()*_this.ctx.canvas.width+1),y:Math.floor(Math.random()*_this.ctx.canvas.height+1)}},this.drawScores=function(x){_this.ctx.fillStyle="white",_this.ctx.clearRect(0,0,300,300),_this.ctx.font="15px Arial",_this.ctx.fillText("score: "+x,10,20);var score=null!=localStorage.highScore&&parseInt(localStorage.highScore)>x?localStorage.highScore:x;localStorage.highScore=score,_this.ctx.fillText("best: "+score,10,35)},this.drawMessage=function(msg){_this.ctx.fillStyle="white",_this.ctx.font="25px Arial",_this.ctx.clearRect(grid.centreSpot().x-50,grid.centreSpot().y-50,550,50),_this.ctx.fillText(msg,_this.centreSpot().x,_this.centreSpot().y)},this.clearMe=function(){_this.ctx.clearRect(0,0,_this.ctx.canvas.width,_this.ctx.canvas.height)}},requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame,update=function update(){count%50!=0&&1!=count||grid.drawScores(points),gamePieces.forEach(function(x){if(x.on&&(x.clearMe(grid),x.forward()),count%(10-x.speed)==0&&x.harmful&&x.pulse(),x!=gamePieces[0]&&gamePieces[0].hasCollided(x)){gamePieces[4].on=points%50==0;var currentShape=gamePieces[0].shape;gamePieces[0].color;x.harmful?(canvas.style["background-color"]="silver",grid.drawMessage("end game"),audioCtx.close(),audioCtx=new AudioContext,cancelAnimationFrame(myReq),myReq=0,grid.clearMe(),setTimeout(function(){startGame(),canvas.style["background-color"]="black"},3e3)):x.speedReset?(gamePieces[0].speed=gamePieces[0].speed>8?gamePieces[0].speed-randomItem(speeds):gamePieces[0].speed,gamePieces.forEach(function(p,i){0!=i&&p.invertDirection()}),gamePieces[4].on=!1,points+=20):(points+=10,grid.drawScores(points),"#00ff00"==x.color?(gamePieces[0].height=gamePieces[0].height+1,gamePieces[0].width=gamePieces[0].width+1):"#ff0000"==x.color&&gamePieces[0].height>5&&(gamePieces[0].height=gamePieces[0].height-1,gamePieces[0].width=gamePieces[0].width-1),count%2==0?(gamePieces.push(new Sawtooth(grid)),gamePieces[gamePieces.length-1].direction=randomItem(directions),gamePieces[gamePieces.length-1].speed=randomItem(speeds)):gamePieces[0].speed=gamePieces[0].speed+1),x.clearMe(grid),gamePieces[0].changeShape(x.shape),x.changeShape(currentShape),x.x=grid.randomSpot().x,x.y=grid.randomSpot().y,x.direction=randomItem(directions),x.speed=randomItem(speeds)}x.on&&x.drawMe(grid)}),count++,myReq=requestAnimationFrame(update)},startGame=function(){gamePieces=new Array,points=0,paused=!0,count=0,grid.clearMe(),gamePieces.push(new Sine(grid)),gamePieces[0].x=grid.centreSpot().x,gamePieces[0].y=grid.centreSpot().y,gamePieces[0].control(),gamePieces.push(new Square(grid)),gamePieces.push(new Sawtooth(grid)),gamePieces.push(new Triangle(grid)),gamePieces.push(new SpeedReset(grid)),gamePieces[gamePieces.length-1].on=!1,gamePieces.filter(function(x,i){return 0!=i}).forEach(function(x){x.direction=randomItem(directions),x.speed=randomItem(speeds)}),grid.drawMessage("use arrow keys"),cancelAnimationFrame(myReq),mute()};document.body.onkeyup=function(e){paused?(myReq=requestAnimationFrame(update),unmute(),paused=!1,grid.ctx.clearRect(grid.centreSpot().x-50,grid.centreSpot().y-50,550,50)):32!=e.keyCode||paused||(cancelAnimationFrame(myReq),mute(),paused=!0)},document.body.ontouchstart=function(){paused&&(myReq=requestAnimationFrame(update),unmute(),paused=!1,grid.ctx.clearRect(grid.centreSpot().x-50,grid.centreSpot().y-50,550,50))},window.onblur=function(){console.log("blurring"),cancelAnimationFrame(myReq),mute(),paused=!0};var grid=new Grid(document.getElementById("canvas")),directions=[0,90,180,270],speeds=[1,2,4],gamePieces=new Array,points=0,paused=!0,myReq,count=0,mute=function(){return gamePieces.forEach(function(x){return x.gainNode.disconnect(audioCtx.destination)})},unmute=function(){return gamePieces.forEach(function(x){return x.gainNode.connect(audioCtx.destination)})};startGame();